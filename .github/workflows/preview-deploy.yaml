name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v4

      # Install Supabase CLI
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # Wait for Supabase branch to be ready
      - name: Wait for Supabase Preview Branch
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-for-supabase
        with:
          checkName: Supabase Preview
          ref: ${{ github.event.pull_request.head.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          timeoutSeconds: 300

      # Get Supabase preview branch credentials
      - name: Get Supabase Branch Credentials
        run: |
          supabase --experimental branches get "${{ github.head_ref }}" -o env > .env.branch

          # Parse each line, strip quotes, add to GITHUB_ENV
          while IFS='=' read -r key value; do
            [[ -z "$key" || "$key" =~ ^# ]] && continue
            # Remove surrounding quotes
            value="${value%\"}"
            value="${value#\"}"
            echo "$key=$value" >> $GITHUB_ENV
          done < .env.branch
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Build with preview Supabase credentials
      - name: Build
        run: npm run build
        env:
          PUBLIC_SUPABASE_URL: ${{ env.SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ env.SUPABASE_ANON_KEY }}

      # Upload version with branch alias
      - name: Deploy Preview
        uses: cloudflare/wrangler-action@v3
        id: deploy
        with:
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: versions upload --preview-alias ${{ github.head_ref }}

      # Update PR description with preview URL
      - name: Update PR Description
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PREVIEW_URL="https://${{ github.head_ref }}-market.kwila-cloud.workers.dev"

          # Get current PR body
          CURRENT_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body -q .body)

          # Remove existing preview URL section if present
          CLEANED_BODY=$(echo "$CURRENT_BODY" | sed '/^---$/,/^ðŸš€ \*\*Preview URL:\*\*/d')

          # Append new preview URL section
          NEW_BODY="${CLEANED_BODY}

---
ðŸš€ **Preview URL:** ${PREVIEW_URL}"

          # Update PR description
          gh pr edit ${{ github.event.pull_request.number }} --body "$NEW_BODY"
